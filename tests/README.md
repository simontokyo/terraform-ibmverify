# IBM Verify Playwright Tests

This directory contains Playwright tests for automating IBM Verify Admin UI tasks, such as creating API clients.

## Prerequisites

1. Node.js (v18 or later recommended)
2. IBM Verify instance deployed using Terraform (from parent directory)
3. Valid IBM ID credentials with access to the IBM Verify Admin UI

## Setup

### 1. Install Dependencies

```bash
cd tests
npm install
npx playwright install chromium
```

### 2. Configure Environment Variables

The tests read configuration from the `.env` file in the parent directory, which is automatically generated by Terraform.

After Terraform generates the `.env` file, you need to add your admin credentials to it:

```bash
# Edit the .env file in the parent directory
cd ..
# Add these lines (uncomment and fill in your credentials):
IBM_VERIFY_ADMIN_EMAIL=your-email@jp.ibm.com
IBM_VERIFY_ADMIN_PASSWORD=your-password
```

Required environment variables:
- `IBM_VERIFY_DASHBOARD_URL` - (auto-generated by Terraform)
- `IBM_VERIFY_ADMIN_EMAIL` - Your IBM ID email address
- `IBM_VERIFY_ADMIN_PASSWORD` - Your IBM ID password

**Note**: Make sure not to commit your `.env` file with credentials to version control!

### 3. Generate .env File with Terraform (if not already done)

If you haven't deployed the IBM Verify instance yet:

```bash
cd ..
terraform init
terraform apply
```

This will create the `.env` file with all the instance URLs and configuration.

## Running Tests

### Run all tests

```bash
npm test
```

### Run tests in headed mode (see the browser)

```bash
npm run test:headed
```

### Run tests in UI mode (interactive)

```bash
npm run test:ui
```

### Test OCR independently

```bash
npm run test:ocr
```

Use this to test OCR processing on the `client-secret-field.png` screenshot without running the full Playwright test. Helpful for debugging OCR settings and image quality.

## Test Description

### `createAPIclient.spec.ts`

This test automates the process of creating an API client in the IBM Verify Admin UI:

1. Navigates to the IBM Verify Admin UI
2. Logs in using IBM ID credentials (from environment variables)
3. Navigates to Security → API access
4. Creates a new API client with all permissions
5. Captures high-resolution screenshot of the client secret field (PNG format with device pixel ratio)
6. Extracts credentials using advanced OCR (Tesseract.js) with optimized settings:
   - Character whitelist (alphanumeric + hyphens/underscores)
   - Single-line recognition mode
   - Special character blacklist for cleaner results
7. **Automatically saves both credentials to the `.env` file**

The test extracts and saves:
- Client ID (directly from input field) to `IBM_VERIFY_API_CLIENT_ID`
- Client Secret (via enhanced OCR processing) to `IBM_VERIFY_API_CLIENT_SECRET`

**Features:**
- 1.5x element scaling for better OCR accuracy
- PNG format screenshots with device pixel ratio
- Optimized OCR configuration for password extraction
- Automatic .env file updates
- Fallback to 'MANUAL_ENTRY_REQUIRED' if OCR fails

Note: After the test completes, the API client credentials will be automatically added to your `.env` file, ready for use in your applications.

### `test-ocr.ts`

Standalone OCR testing script that:
1. Loads the `client-secret-field.png` screenshot
2. Shows image metadata (dimensions, format, channels)
3. Creates an enhanced version (3x upscale, greyscale, normalized, sharpened)
4. Runs OCR with the same settings as the main test
5. Displays detailed results including confidence score

Use this for debugging OCR accuracy without running the full Playwright test.

## Troubleshooting

### Missing environment variables

If you get an error about missing environment variables:
1. Check that the `.env` file exists in the parent directory
2. Ensure you've added `IBM_VERIFY_ADMIN_EMAIL` and `IBM_VERIFY_ADMIN_PASSWORD` to the `.env` file
3. Run `terraform apply` to regenerate the `.env` file if needed

### Test timeout

The test has a 240-second timeout. If it times out:
1. Check your network connection
2. Verify your credentials are correct
3. The IBM Verify instance might be slow to respond - try running again

### OCR not working

If Tesseract.js fails to extract the client secret:
1. Run `npm run test:ocr` to test OCR independently and see detailed diagnostics
2. Check the generated `client-secret-field.png` screenshot
3. Verify the screenshot contains visible text
4. Check OCR confidence score - low confidence indicates image quality issues
5. The test will save 'MANUAL_ENTRY_REQUIRED' if OCR fails - you can manually add the secret from the screenshot

**OCR Optimization:**
- Screenshots are taken at 1.5x scale for better clarity
- PNG format with device pixel ratio for lossless quality
- Character whitelist restricts recognition to valid password characters
- Single-line mode optimized for password fields

## Security Notes

- **Never commit** the `.env` file with real credentials
- Store credentials securely
- Use environment-specific `.env` files for different deployments
- Consider using a secrets manager for production use

## File Structure

```
tests/
├── createAPIclient.spec.ts  # Playwright test for creating API clients
├── test-ocr.ts              # Standalone OCR testing script
├── package.json             # Node.js dependencies
├── playwright.config.ts     # Playwright configuration
├── tsconfig.json            # TypeScript configuration
├── .gitignore               # Git ignore rules
└── README.md                # This file
```

## Dependencies

- **@playwright/test** - Browser automation framework
- **tesseract.js** - OCR engine for extracting text from screenshots
- **sharp** - High-performance image processing for OCR enhancement
- **dotenv** - Environment variable management
- **tsx** - TypeScript execution for test-ocr.ts
- **typescript** - TypeScript compiler

